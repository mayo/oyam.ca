{% set microblog = not article.title %}
{% if article.excerpt and article.type != "link" and article.type != 'quote' and article.type != 'photo' %}
  {% set has_excerpt = True %}
{% endif %}

<article class="{{ article.type }} h-entry">
  {% set post_link = "/" + article.path %}
  {% if article.type == "link" %}
    {% set post_link = article.href %}
  {% endif %}

  <header>
    {% if article.title and not article.type == 'quote' %}
      {% if article_context == "list" %}
        <h2><a href="{{ post_link }}" class="p-name">{{ article.title|safe }}</a></h2>
      {% else %}
        <h1 class="p-name">{{ article.title|safe }}</h1>
      {% endif %}
    {% endif %}

    <time class="post-time dt-published" datetime="{{ article.created.strftime('%Y-%m-%dT%H:%M:%SZ') }}">{{ article.created.strftime('%A, %B %d, %Y') }}</time>
    <a class="u-author" href="/"></a>
  </header>

  {% set extra_content_class="" %}
  {% if article_context == "list" and has_excerpt %}
    {% set extra_content_class="excerpt" %}
  {% endif %}

  <div class="content {{ extra_content_class }} e-content">
    {% if article_context == "list" and article.type != "link" %}
      <a class="readmore" href="{{ post_link }}">
    {% endif %}

    {% if article_context == "list" and not microblog and article.type != "link" and article.type != 'photo' %}

      {% set header_style = [] %}
      {% if article.header %}
        {% if article.header.image %}
          {% do header_style.append("background-image: url('%s');" % article.header.image) %}
        {% endif %}
        {% if article.header.image_position %}
          {% do header_style.append("background-position: %s;" % article.header.image_position) %}
        {% endif %}
      {% endif %}

      {% if header_style %}
      <div class="header-image" style="{{ header_style|join(" ") }}"></div>
      {% endif %}

      {{ article.excerpt|safe }}
    {% else %}
      {{ article.contents|safe }}
    {% endif %}

    {% if article_context == "list" and article.type != "link" %}
      </a>
    {% endif %}
  </div>

  {% if article.type == "quote" %}
  <p class="article author">&mdash; {{ article.author }}</p>
  {% endif %}

  <footer>
    {% if (article.type == "link" and article.href) or microblog  %}
    <ul class="fa-ul links">
      {# Don't show permalinks for quotes, they never have titles and are "microblog" posts #}
      {% if article_context == "list" or microblog and article.type != "quote" %}
      <li><i class="fa-li fa fa-bookmark-o"></i><a class="permalink" href="/{{ article.path }}">Permalink</a></li>
      {% endif %}

      {% if article.href %}
      <li><i class="fa-li fa fa-external-link"></i><a class="extlink" href="{{ article.href }}">{{ article.href }}</a></li>
      {% endif %}
      {% if article.source %}
      <li><i class="fa-li fa fa-external-link"></i><a class="extlink" href="{{ article.source_link }}">{{ article.source }}</a></li>
      {% endif %}
    </ul>
    {% endif %}
  </footer>
</article>
