{% set microblog = not article.title %}
{% if article.excerpt and article.type != "link" and article.type != 'quote' and article.type != 'photo' %}
  {% set has_excerpt = True %}
{% endif %}

<article class="{{ article.type }}">
  {% set post_link = "/" + article.path %}
  {% if article.type == "link" %}
    {% set post_link = article.href %}
  {% endif %}

  <header>
    {% if article.title and not article.type == 'quote' %}
      {% if article_context == "list" %}
        <h2><a href="{{ post_link }}">{{ article.title|safe }}</a></h2>
      {% else %}
        <h1>{{ article.title|safe }}</h1>
      {% endif %}
    {% endif %}

    <time class="post-time" datetime="{{ article.created.strftime('%Y-%m-%dT%H:%M:%SZ') }}">{{ article.created.strftime('%A, %B %d, %Y') }}</time>
  </header>

  {% set extra_content_class="" %}
  {% if article_context == "list" and has_excerpt %}
    {% set extra_content_class="excerpt" %}
  {% endif %}

  <div class="content {{ extra_content_class }}">
    {% if article_context == "list" and article.type != "link" %}
      <a class="readmore" href="{{ post_link }}">
    {% endif %}

    {# Only photos that don't have contents get figure wrapper, the others should have regular content #}
    {% if article.type == "photo" and not article.contents %}
      <figure>
        <img src="/media/images/photos/{{ article.created.strftime('%Y/%m') }}/{{ article.photo }}" title="{{ article.title or article.caption }}" width="900"/>
        <figcaption>{{ article.caption }}</figcaption>
      </figure>

    {% elif article.type == 'quote' %}
      {# Title based quotes don't have paragraph tag #}
      {% if article.contents %}
        {{ article.contents|safe }}
      {% else %}
        <p>{{ article.title|safe }}</p>
      {% endif %}
    {% elif article_context == "list" and article.type != "link" and article.type != 'photo' %}

      {% set header_style = [] %}
      {% if article.header %}
        {% if article.header.image %}
          {% do header_style.append("background-image: url('%s');" % article.header.image) %}
        {% endif %}
        {% if article.header.image_position %}
          {% do header_style.append("background-position: %s;" % article.header.image_position) %}
        {% endif %}
      {% endif %}

      {% if header_style %}
      <div class="header-image" style="{{ header_style|join(" ") }}"></div>
      {% endif %}

      {{ article.excerpt|safe }}
    {% else %}
      {{ article.contents|safe }}
    {% endif %}

    {% if article_context == "list" and article.type != "link" %}
      </a>
    {% endif %}
  </div>

  {% if article.type == "quote" %}
  <p class="article author">&mdash; {{ article.author }}</p>
  {% endif %}

  <footer>
    {% if (article.type == "link" and article.href) or microblog  %}
    <ul class="fa-ul links">
      {% if article_context == "list" or microblog %}
      <li><i class="fa-li fa fa-bookmark-o"></i><a class="permalink" href="/{{ article.path }}">Permalink</a></li>
      {% endif %}

      {% if article.href %}
      <li><i class="fa-li fa fa-external-link"></i><a class="extlink" href="{{ article.href }}">{{ article.href }}</a></li>
      {% endif %}
      {% if article.source %}
      <li><i class="fa-li fa fa-external-link"></i><a class="extlink" href="{{ article.source_link }}">{{ article.source }}</a></li>
      {% endif %}
    </ul>
    {% endif %}
  </footer>
</article>
